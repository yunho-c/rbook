# Test Strategy

This document describes how to keep `rbook` tests fast, maintainable, and representative of real-world EPUB behavior.

## Goals

- Catch regressions in TOC/spine/manifest parsing with small, deterministic fixtures.
- Validate behavior against real-world EPUBs without slowing the core test suite.
- Keep test data provenance clear and reproducible.

## Test tiers

1) **Unit/fixture tests (always-on)**
   - Use tiny handbuilt EPUBs that isolate a single behavior.
   - Stored under `tests/ebooks/fixtures/`.
   - Generated by `scripts/gen_epub_fixtures.py`.
   - Expected structures (TOC, spine, manifest) are asserted directly.

2) **Integration tests (curated external fixtures)**
   - Use a small subset of W3C/IDPF/EPUBCheck/Readium samples.
   - Stored under `tests/ebooks/external/` (proposed).
   - Each fixture must include a `SOURCE.md` with exact origin/version/license.
   - Tests focus on higher-level correctness rather than exhaustive edge cases.

3) **Real-book tests (optional/slow)**
   - Use 1â€“3 public-domain EPUBs (e.g., Standard Ebooks or Gutenberg).
   - Mark as ignored or behind a feature flag (see below).
   - Intended to smoke-test unusual combinations found in the wild.

## Fixture management

- **Single source of truth:** do not hand-edit files in `tests/ebooks/fixtures/*`. Update `scripts/gen_epub_fixtures.py` and regenerate.
- **Provenance:** every external fixture must ship with a `SOURCE.md` describing where it came from and its license.
- **Minimalism:** fixtures should be as small as possible while exercising the target behavior.

## Assertions and helpers

- Centralize fixture loading in a helper (e.g., `tests/epub/fixtures.rs`).
- Use shared assertion helpers to compare parsed entries to expected data.
- Prefer data-driven expectations (small structs or JSON files) over repeating per-test boilerplate.

## Gating slow tests

- Keep tier-1 tests fast and always-on.
- Gate tier-2 and tier-3 tests behind a feature flag, e.g.:
  - `cargo test --features external-fixtures`
  - `cargo test --features real-books`
- Alternatively use `#[ignore]` on slow tests and document how to run them.

## Updating fixtures

1) Edit `scripts/gen_epub_fixtures.py`.
2) Run `python3 scripts/gen_epub_fixtures.py`.
3) Review changes under `tests/ebooks/fixtures/`.
4) Update or add expectations in the test files.

## What to add next

- Wire new fixture-based TOC tests for:
  - multiple navs,
  - deep nesting,
  - edge-case hrefs,
  - EPUB2 nested NCX.
- Add a minimal curated set of external fixtures with clear provenance.
